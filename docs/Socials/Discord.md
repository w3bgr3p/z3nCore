

##  Discord

### Назначение

Класс `Discord` реализует интеграцию и автоматизацию работы с Discord через API и браузерный интерфейс в ZennoPoster. Позволяет управлять ролями пользователей, получать и устанавливать учётные данные, выполнять авторизацию, автоматизировать обход капчи, получать токен, а также собирать список серверов пользователя.

---

### Примеры использования

```csharp
// Создать экземпляр с логированием
var discord = new Discord(project, instance, log: true);

// Выдать роль пользователю
bool ok = discord.ManageRole(botToken, guildId, "Member", userId, assignRole: true);

// Получить статус и токен из базы
string status = discord.CredsFromDb();

// Залогиниться в Discord через браузер
string state = discord.DSload();

// Получить список серверов пользователя
string servers = discord.DSservers();
```


---

## Описание методов

### Log

```csharp
public void Log(string tolog = "", string callerName = "", bool log = false)
```

- Логирует сообщение через внешний Logger.
- callerName определяется автоматически, если не передан.

---

### ManageRole

```csharp
public bool ManageRole(string botToken, string guildId, string roleName, string userId, bool assignRole, string callerName = "")
```

- Получает список ролей сервера через Discord API.
- Находит роль по имени (`roleName`).
- В зависимости от `assignRole`:
    - true: выдаёт роль пользователю (PUT-запрос)
    - false: удаляет роль у пользователя (DELETE-запрос)
- Логирует все действия и ошибки.
- Возвращает true при успехе, false при ошибке.

---

### CredsFromDb

```csharp
public string CredsFromDb()
```

- Получает из базы (`private_discord`) статус, токен, логин, пароль, OTP-секрет.
- Заполняет переменные проекта:
    - `discordSTATUS`
    - `discordTOKEN`
    - `discordLOGIN`
    - `discordPASSWORD`
    - `discord2FACODE`
- Возвращает статус (`discordSTATUS`).

---

### DSsetToken

```csharp
private void DSsetToken()
```

- Устанавливает токен Discord в localStorage через выполнение JS-кода в браузере.
- Используется для обхода стандартного логина и ускорения авторизации.

---

### DSgetToken

```csharp
private string DSgetToken()
```

- Извлекает токен Discord из заголовков трафика (RequestHeaders) для запроса `https://discord.com/api/v9/science`.
- Использует регулярное выражение для поиска значения `Authorization`.

---

### DSlogin

```csharp
private string DSlogin()
```

- Выполняет авторизацию через браузер:
    - Вводит логин и пароль.
    - Нажимает кнопку "Submit".
    - Ожидает появления окна капчи или поля для 2FA.
    - Если возникает капча — запускает решение через CapGuru.
    - Вводит 2FA-код и завершает авторизацию.
- Возвращает `"ok"` при успехе.

---

### DSload

```csharp
public string DSload(bool log = false)
```

- Загружает и актуализирует креды из базы.
- Открывает Discord в браузере, пытается авторизоваться:
    - Если требуется логин — устанавливает токен через JS, либо проходит стандартный логин.
    - Если требуется капча — решает через CapGuru.
    - После входа кликает по кнопке "Apply" (если есть).
    - Получает имя пользователя/статус авторизации.
    - Получает токен и сохраняет его в базу.
- Возвращает статус (имя пользователя или состояние).

---

### DSservers

```csharp
public string DSservers()
```

- Включает эмуляцию мыши.
- Получает список серверов пользователя:
    - Проходит по списку элементов с серверами и папками.
    - Для папок кликает по ним и собирает вложенные серверы.
- Объединяет имена серверов в строку через `" | "`.
- Сохраняет результат в базу (`servers` в таблице `discord`).
- Возвращает строку с именами серверов.

---

## Вспомогательные (внутренние) детали

- Используется класс `Sql` для работы с базой данных.
- Все сетевые запросы выполняются через `NetHttp`.
- Для логирования используется внешний Logger (`L0g`).
- Для решения капчи интегрирован вызов CapGuru.
- Для работы с трафиком используется класс `Traffic`.

---
