

##  DMail

### Назначение

Класс **DMail** реализует автоматизацию работы с сервисом dmail.ai через API: авторизация по EVM-ключу, получение и чтение писем, массовое извлечение сообщений, отметка писем как прочитанных, удаление в корзину, получение статистики непрочитанных писем. Поддерживает работу с прокси, логирование, интеграцию с переменными и базой проекта ZennoPoster.

### Примеры использования

```csharp
// Создать экземпляр с логированием и EVM-ключом
var dmail = new DMail(project, key: "0x...", log: true);

// Авторизация по EVM-ключу
dmail.Auth();

// Получить все письма из inbox
var allMail = dmail.GetAll();

// Прочитать первое письмо, отметить как прочитанное и удалить в корзину
var msg = dmail.ReadMsg(0);

// Получить количество непрочитанных писем
string unreadCount = dmail.GetUnread(key: "mail_unread_count");

// Пометить письмо как прочитанное
dmail.MarkAsRead(0);

// Удалить письмо в корзину
dmail.Trash(0);
```


## Описание методов

### Конструктор

```csharp
public DMail(IZennoPosterProjectModel project, string key = null, bool log = false)
```

- **project**: объект ZennoPoster.
- **key**: приватный EVM-ключ (если не задан — берётся из базы).
- **log**: включает логирование.
- В конструкторе выполняется авторизация (`CheckAuth`) и подготовка заголовков для запросов.


### Auth

```csharp
public void Auth()
```

- Авторизация через EVM-ключ:

1. Получает nonce через API.
2. Формирует сообщение для подписи.
3. Подписывает сообщение приватным ключом.
4. Отправляет подпись на верификацию.
5. Получает токен (`encstring`) и идентификатор пользователя (`pid`).
6. Сохраняет их в переменные проекта и в поля экземпляра.
7. Формирует заголовки для последующих запросов.


### CheckAuth

```csharp
public void CheckAuth()
```

- Проверяет наличие токена и pid в памяти или переменных проекта.
- Если отсутствуют — выполняет авторизацию (`Auth`).
- После успешной авторизации формирует заголовки для API-запросов.


### GetAll

```csharp
public dynamic GetAll()
```

- Получает список всех писем пользователя из inbox.
- Формирует тело запроса с параметрами страницы и размера.
- Выполняет POST-запрос к API dmail.
- Сохраняет результат в поле `_allMail` и возвращает список писем.


### ReadMsg

```csharp
public Dictionary ReadMsg(int index = 0, dynamic mail = null, bool markAsRead = true, bool trash = true)
```

- Читает письмо по индексу из списка (или из `_allMail`).
- Извлекает отправителя, дату, тему, html-содержимое, служебные id.
- По умолчанию отмечает письмо как прочитанное (`markAsRead = true`) и удаляет в корзину (`trash = true`).
- Возвращает словарь с данными письма.


### GetUnread

```csharp
public string GetUnread(bool parse = false, string key = null)
```

- Получает статистику по непрочитанным письмам через API.
- Если указан `key`, возвращает конкретное поле (`mail_unread_count`, `message_unread_count`, `not_read_count`, `used_total_size`).
- Если ключ не найден — возвращает пустую строку.


### Trash

```csharp
public void Trash(int index = 0, string dm_scid = null, string dm_smid = null)
```

- Перемещает письмо в корзину.
- Если id не переданы — извлекает их из письма по индексу.
- Формирует и отправляет POST-запрос на обновление статуса письма.


### MarkAsRead

```csharp
public void MarkAsRead(int index = 0, string dm_scid = null, string dm_smid = null)
```

- Помечает письмо как прочитанное.
- Если id не переданы — извлекает их из письма по индексу.
- Формирует и отправляет POST-запрос на обновление статуса письма.


### KeyCheck

```csharp
private string KeyCheck(string key = null)
```

- Проверяет и возвращает EVM-ключ для авторизации.
- Если ключ не задан — берёт из базы через Sql.Key("evm").
- Если ключ отсутствует — выбрасывает исключение.


### Вспомогательные детали

- Все запросы выполняются через NetHttp с поддержкой прокси и логированием.
- Для подписания сообщений используется Nethereum.Signer.
- Все ключевые параметры (token, pid) сохраняются в переменные проекта.
- Логирование интегрировано через внешний Logger и project.L0g.
- Работа с письмами реализована через динамические объекты и словари для гибкости.


