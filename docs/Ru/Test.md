# Документация классов _Accountant и Test

Эти классы предоставляют функционал для отчетов о балансах и утилиты для проектов ZennoPoster.

---

## Класс _Accountant

Генерирует HTML отчеты для визуализации балансов криптовалют с тепловыми картами и статистикой.

### Конструктор

**Назначение**: Инициализирует экземпляр Accountant с опциональным логированием.

**Пример**:
```csharp
// Создать accountant с включенным логированием
var accountant = new _Accountant(project, log: true);

// Создать accountant без логирования
var accountant = new _Accountant(project);
```

**Разбор**:
```csharp
public _Accountant(
    IZennoPosterProjectModel project,  // Экземпляр проекта ZennoPoster
    bool log = false)                  // Включить детальное логирование
{
    // Инициализирует ссылку на проект
    // Создает логгер с эмодзи класса "$"
    // Устанавливает пороги балансов и константы форматирования
}
```

---

### ShowBalanceTable

**Назначение**: Генерирует HTML таблицу-отчет с данными балансов из базы данных и опционально открывает в браузере.

**Пример**:
```csharp
var accountant = new _Accountant(project);

// Показать балансы для всех сетей из таблицы _native
accountant.ShowBalanceTable(chains: null, call: true);

// Показать только конкретные сети
accountant.ShowBalanceTable(
    chains: "ethereum,bsc,polygon",
    single: false,
    call: true
);

// Сгенерировать отчет без открытия браузера
accountant.ShowBalanceTable(chains: "arbitrum,optimism", call: false);
```

**Разбор**:
```csharp
public void ShowBalanceTable(
    string chains = null,      // Имена сетей через запятую, null = все сети из таблицы _native
    bool single = false,       // Принудительно использовать одноколоночный вид даже для малых датасетов
    bool call = false)         // Открыть отчет в браузере по умолчанию
{
    // Запрашивает данные балансов из таблицы _native
    // Использует переменную проекта "rangeEnd" для ограничения строк
    // Автоматически выбирает layout: многоколоночный для ≤3 сетей и ≥100 строк, иначе одноколоночный
    // Применяет цветовое кодирование на основе порогов баланса:
    //   - Синий (≥0.1), Зеленый (≥0.01), Желто-Зеленый (≥0.001)
    //   - Хаки (≥0.0001), Лососевый (≥0.00001), Красный (>0), Белый (=0)
    // Сохраняет HTML в .data/balanceReport.html
    // Включает пагинацию (50 строк на страницу)
    // Показывает статистику: всего аккаунтов, активных аккаунтов, аккаунтов ≥0.1, общая сумма
}
```

---

### ShowBalanceTableHeatmap

**Назначение**: Генерирует интерактивную тепловую карту балансов по сетям.

**Пример**:
```csharp
var accountant = new _Accountant(project);

// Показать тепловую карту для всех сетей
accountant.ShowBalanceTableHeatmap(call: true);

// Показать тепловую карту для конкретных сетей
accountant.ShowBalanceTableHeatmap(
    chains: "ethereum,bsc,polygon,arbitrum",
    call: true
);
```

**Разбор**:
```csharp
public void ShowBalanceTableHeatmap(
    string chains = null,     // Имена сетей через запятую, null = все колонки кроме id
    bool call = false)        // Открыть в браузере
{
    // Запрашивает таблицу _native для всех балансов аккаунтов
    // Создает сетку из цветных ячеек (тепловую карту) для каждой комбинации аккаунт+сеть
    // Цвет каждой ячейки представляет уровень баланса (та же цветовая схема что и в таблице)
    // При наведении показывает подсказку с номером аккаунта, сетью и точным балансом
    // Клик по ячейке копирует информацию в буфер обмена
    // Отображает статистику по сети: аккаунты с балансом, мин/макс/средн, итого, покрытие%
    // Сохраняет в .data/balanceHeatmap.html
    // Использует стилизацию GitHub Dark темы
    // Включает карточки сводки: всего аккаунтов, активных аккаунтов, общий баланс
}
```

---

### ShowBalanceTableFromList

**Назначение**: Генерирует отчет о балансах из списка строк "аккаунт:баланс".

**Пример**:
```csharp
var accountant = new _Accountant(project);

var balanceData = new List<string>
{
    "Аккаунт №1:0.5432",
    "Аккаунт №2:1.2345",
    "Аккаунт №3:0.0001",
    "Аккаунт №4:0"
};

accountant.ShowBalanceTableFromList(balanceData, call: true);
```

**Разбор**:
```csharp
public void ShowBalanceTableFromList(
    List<string> data,     // Список строк "аккаунт:баланс"
    bool call = false)     // Открыть в браузере
{
    // Парсит каждую строку ожидая формат: "имя_аккаунта:значение_баланса"
    // Применяет цветовое кодирование баланса
    // Вычисляет общую сумму
    // Сохраняет в .data/balanceListReport.html
    // Включает пагинацию для больших датасетов
    // Показывает итоговую строку с общим балансом
}
```

---

## Класс Test

Статические утилитарные методы для манипуляции строками.

### GetFileNameFromUrl

**Назначение**: Извлекает имя файла из URL или HTML атрибута, с опциональным удалением расширения.

**Пример**:
```csharp
// Извлечь имя файла из URL
string url = "https://example.com/images/photo.jpg?version=1";
string filename = url.GetFileNameFromUrl(withExtension: true);
// Результат: "photo.jpg"

// Извлечь имя файла без расширения
string filenameNoExt = url.GetFileNameFromUrl(withExtension: false);
// Результат: "photo"

// Извлечь из HTML атрибута src
string html = "<img src='https://cdn.example.com/assets/logo.png' />";
string logoFile = html.GetFileNameFromUrl(withExtension: true);
// Результат: "logo.png"

// Извлечь из HTML href
string link = "href=\"/downloads/file.pdf\"";
string pdfName = link.GetFileNameFromUrl(withExtension: false);
// Результат: "file"
```

**Разбор**:
```csharp
public static string GetFileNameFromUrl(
    this string input,           // URL строка или HTML с атрибутом src/href
    bool withExtension = false)  // Включить расширение файла в результат
{
    // Ищет атрибуты src или href в HTML (без учета регистра)
    // Извлекает URL из атрибута или использует input как есть если атрибут не найден
    // Извлекает последний сегмент пути (имя файла) из URL
    // Удаляет параметры запроса (все после ?)
    // Если withExtension равно false, удаляет расширение файла
    // Возвращает исходный input при ошибке парсинга
    // Обрабатывает пути с разделителями / или \
}
```

---

## Пороги цветового кодирования балансов

И `ShowBalanceTable`, и `ShowBalanceTableHeatmap` используют эти пороги:

| Диапазон баланса | Цвет | CSS класс |
|-----------------|------|-----------|
| ≥ 0.1 | Синий (#4682B4) | `balance-highest` |
| ≥ 0.01 | Зеленый (#228B22) | `balance-high` |
| ≥ 0.001 | Желто-Зеленый (#9ACD32) | `balance-medium` |
| ≥ 0.0001 | Хаки (#F0E68C) | `balance-low` |
| ≥ 0.00001 | Лососевый (#FFA07A) | `balance-verylow` |
| > 0 | Красный (#CD5C5C) | `balance-minimal` |
| = 0 | Прозрачный/Серый | `balance-zero` |

---

## Возможности отчетов

Все HTML отчеты включают:

- **GitHub Dark тему** - консистентная стилизация с современным темным UI
- **Адаптивный дизайн** - подстраивается под разные размеры экрана
- **Пагинацию** - навигация стрелками клавиатуры или кнопками
- **Моноширинный шрифт** - Iosevka/Consolas для точного выравнивания чисел
- **Сводную статистику** - быстрый обзор ключевых метрик
- **Интерактивные элементы** - эффекты наведения, кликабельные ячейки (тепловая карта)

---

## Расположение файлов

Сгенерированные отчеты сохраняются в:
- `{project.Path}/.data/balanceReport.html` - стандартный табличный отчет
- `{project.Path}/.data/balanceHeatmap.html` - визуализация тепловой картой
- `{project.Path}/.data/balanceListReport.html` - отчет на основе списка

---

## Лучшие практики

1. **Установите переменную rangeEnd** перед вызовом отчетов о балансах чтобы ограничить область запроса
2. **Используйте конкретные сети** в параметре для более быстрых отчетов когда нужны только определенные сети
3. **Отключайте параметр call** при программной генерации множественных отчетов
4. **Включайте логирование** во время разработки для отладки проблем с данными
5. **Используйте тепловую карту** для быстрого визуального обзора многих аккаунтов по сетям
6. **Используйте табличный вид** для детального численного анализа

---

