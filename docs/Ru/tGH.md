# Документация классов tGit и GHsync

Эти классы предоставляют функционал синхронизации репозиториев GitHub для проектов ZennoPoster.

---

## Класс tGit

Современная, переработанная реализация для синхронизации репозиториев GitHub с улучшенной обработкой ошибок и валидацией.

### Конструктор

**Назначение**: Инициализирует новый экземпляр tGit с учетными данными для аутентификации GitHub.

**Пример**:
```csharp
// Создать экземпляр синхронизации GitHub
var gitSync = new tGit(
    project: project,
    token: "ghp_xxxxxxxxxxxxxxxxxxxx",
    username: "myusername",
    organization: null  // Опционально: использовать организацию вместо репозиториев пользователя
);
```

**Разбор**:
```csharp
public tGit(
    IZennoPosterProjectModel project,  // Экземпляр проекта ZennoPoster
    string token,                       // Персональный токен доступа GitHub (должен начинаться с "ghp_")
    string username,                    // Имя пользователя GitHub
    string organization = null)         // Опционально: имя организации GitHub
{
    // Валидирует формат токена (должен начинаться с "ghp_")
    // Валидирует что имя пользователя не пустое
    // Выбрасывает ArgumentNullException если project равен null
    // Выбрасывает ArgumentException если токен или имя пользователя невалидны
}
```

---

### SyncRepositories

**Назначение**: Синхронизирует локальные директории с репозиториями GitHub на основе конфигурационного файла.

**Пример**:
```csharp
var gitSync = new tGit(project, token, username);

// Синхронизировать все репозитории из .sync.txt
gitSync.SyncRepositories(
    baseDir: @"C:\Projects",
    commitMessage: "Обновлен код"
);

// Использовать временную метку как сообщение коммита
gitSync.SyncRepositories(
    baseDir: @"C:\Projects",
    commitMessage: "ts"  // Будет использована текущая временная метка UTC
);
```

**Разбор**:
```csharp
public void SyncRepositories(
    string baseDir,                    // Базовая директория с проектами для синхронизации
    string commitMessage = "ts")       // Сообщение коммита ("ts" = авто временная метка)
{
    // Читает файл .sync.txt из baseDir для списка проектов
    // Валидирует существование директории и наличие токена
    // Для каждого проекта:
    //   - Проверяет лимиты размера репозитория (макс 100МБ на файл, 1000МБ всего)
    //   - Инициализирует git репозиторий если нужно
    //   - Настраивает удаленный URL с аутентификацией
    //   - Создает/обновляет .gitignore
    //   - Коммитит и пушит изменения если они есть
    // Пропускает проекты отмеченные "false" в .sync.txt
    // Логирует подробную статистику в конце
    // Использует задержки между операциями чтобы избежать ограничения частоты
}
```

---

### Main (Устаревший)

**Назначение**: Устаревший метод для обратной совместимости.

**Пример**:
```csharp
var gitSync = new tGit(project);
gitSync.Main(
    baseDir: @"C:\Projects",
    token: "ghp_token",
    username: "myusername",
    commitMessage: "update"
);
```

**Разбор**:
```csharp
[Obsolete("Используйте конструктор с параметрами и SyncRepositories()")]
public void Main(
    string baseDir,          // Путь к базовой директории
    string token,            // Токен GitHub
    string username,         // Имя пользователя GitHub
    string commitMessage = "ts")  // Сообщение коммита
{
    // Создает временный экземпляр tGit и вызывает SyncRepositories
    // Сохранен только для обратной совместимости
    // Рекомендуется использовать новый конструктор
}
```

---

### GetFileHash

**Назначение**: Вычисляет MD5 хеш файла для обнаружения изменений.

**Пример**:
```csharp
// Получить хеш файла
string hash = tGit.GetFileHash(@"C:\path\to\file.txt");
project.SendInfoToLog($"Хеш файла: {hash}");

// Сравнить файлы
string hash1 = tGit.GetFileHash("file1.txt");
string hash2 = tGit.GetFileHash("file2.txt");
if (hash1 == hash2)
{
    project.SendInfoToLog("Файлы идентичны");
}
```

**Разбор**:
```csharp
public static string GetFileHash(string filePath)
{
    // Параметр: filePath - абсолютный путь к файлу
    // Возвращает: string - MD5 хеш в нижнем регистре без тире
    // Возвращает: пустую строку при ошибке
    // Использует алгоритм MD5 для быстрого вычисления хеша
    // Корректно освобождает поток и экземпляр MD5
}
```

---

## Класс GHsync

Устаревшая реализация синхронизации GitHub. Используйте `tGit` для новых проектов.

### Конструктор

**Назначение**: Инициализирует экземпляр GHsync.

**Пример**:
```csharp
var sync = new GHsync(project);
```

**Разбор**:
```csharp
public GHsync(IZennoPosterProjectModel project)
{
    // Инициализирует ссылку на проект и логгер
    // Устанавливает лимиты размера и правила исключения файлов
}
```

---

### Main

**Назначение**: Синхронизирует репозитории с GitHub (устаревший метод).

**Пример**:
```csharp
var sync = new GHsync(project);
sync.Main(
    baseDir: @"C:\MyProjects",
    token: "ghp_token",
    username: "myuser",
    commmit: "ежедневное обновление"
);
```

**Разбор**:
```csharp
public void Main(
    string baseDir,          // Базовая директория с проектами
    string token,            // Персональный токен доступа GitHub
    string username,         // Имя пользователя GitHub
    string commmit = "ts")   // Сообщение коммита
{
    // Читает конфигурационный файл .sync.txt
    // Валидирует директорию, формат токена и имя пользователя
    // Обрабатывает каждую директорию проекта:
    //   - Валидирует размер репозитория (макс 100МБ на файл, 1000МБ всего, макс 10000 файлов)
    //   - Исключает бинарные и большие файлы (.exe, .zip, медиа файлы, и т.д.)
    //   - Инициализирует git если нужно
    //   - Добавляет remote origin с токен аутентификацией
    //   - Создает/обновляет .gitignore с общими паттернами
    //   - Коммитит и принудительно пушит в ветку master
    // Логирует итоговую статистику (всего, изменений, пропущено, закоммичено, ошибок)
}
```

---

### GetFileHash

**Назначение**: Вычисляет MD5 хеш файла.

**Пример**:
```csharp
string hash = GHsync.GetFileHash("myfile.txt");
```

**Разбор**:
```csharp
public static string GetFileHash(string filePath)
{
    // Параметр: filePath - путь к файлу
    // Возвращает: string - MD5 хеш в шестнадцатеричном формате нижнего регистра
    // Возвращает: пустую строку если файл не может быть прочитан
    // Та же реализация что и tGit.GetFileHash
}
```

---

## Формат конфигурационного файла

Оба класса используют файл `.sync.txt` в базовой директории:

```
ProjectFolder1
ProjectFolder2
ProjectFolder3:false
AnotherProject
```

- Каждая строка содержит имя папки проекта
- Добавьте `:false` чтобы пропустить синхронизацию для этого проекта
- Пустые строки игнорируются

---

## Лимиты размера и файлов

Оба класса применяют эти лимиты:

- **MAX_FILE_SIZE_MB**: 100 МБ на файл
- **MAX_TOTAL_SIZE_MB**: 1000 МБ общий размер репозитория
- **MAX_FILES_COUNT**: максимум 10,000 файлов
- **Исключенные расширения**: .exe, .dll, .zip, .rar, медиа файлы, базы данных, и т.д.

---

## Лучшие практики

1. **Используйте tGit для новых проектов** - лучшая обработка ошибок и валидация
2. **Создайте .sync.txt** перед запуском чтобы указать какие папки синхронизировать
3. **Используйте осмысленные сообщения коммитов** или "ts" для автоматических временных меток
4. **Мониторьте логи** на предмет предупреждений о лимитах размера и ошибок
5. **Держите репозитории в пределах лимитов** чтобы избежать пропусков
6. **Используйте .gitignore** чтобы исключить артефакты сборки и зависимости

---

