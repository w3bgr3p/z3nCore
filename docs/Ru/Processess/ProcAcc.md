# Класс ProcAcc

**Пространство имен:** `z3nCore.Utilities`

Управление связями между идентификаторами процессов (PID) и именами аккаунтов (ACC). Этот класс предоставляет методы для отслеживания, запроса и управления процессами браузера, связанными с конкретными аккаунтами.

---

## GetAllPidAcc

### Назначение
Получает все связи PID → ACC с поддержкой кэширования. Кэш действителен 2 секунды по умолчанию.

### Пример
```csharp
// Получить все связи PID-ACC (использует кэш если доступен)
var allPids = ProcAcc.GetAllPidAcc();
foreach (var pair in allPids)
{
    int pid = pair.Key;         // Идентификатор процесса
    string acc = pair.Value;    // Имя аккаунта
    Console.WriteLine($"PID {pid} → ACC {acc}");
}

// Принудительно обновить кэш
var freshPids = ProcAcc.GetAllPidAcc(forceRefresh: true);
```

### Разбор
```csharp
public static Dictionary<int, string> GetAllPidAcc(bool forceRefresh = false)
```
- **Параметр `forceRefresh`**: Установите `true` чтобы обойти кэш и немедленно просканировать все процессы
- **Возвращает**: Словарь где ключ - PID (int), значение - имя аккаунта (string)
- **Потокобезопасность**: Использует внутреннюю блокировку
- **Кэширование**: Результаты кэшируются на 2 секунды, если не указан `forceRefresh = true`

---

## GetPids

### Назначение
Получает все идентификаторы процессов, связанные с конкретным именем аккаунта.

### Пример
```csharp
// Получить все PID для аккаунта "acc123"
List<int> pids = ProcAcc.GetPids("acc123");

if (pids.Count > 0)
{
    Console.WriteLine($"У аккаунта acc123 запущено {pids.Count} процесс(ов)");
    foreach (int pid in pids)
    {
        Console.WriteLine($"  - PID: {pid}");
    }
}
else
{
    Console.WriteLine("Аккаунт не запущен");
}
```

### Разбор
```csharp
public static List<int> GetPids(string acc)
```
- **Параметр `acc`**: Имя аккаунта для поиска (нормализуется автоматически)
- **Возвращает**: Список идентификаторов процессов, связанных с аккаунтом (пустой список если не найдено)
- **Примечание**: Имя аккаунта нормализуется (удаляется префикс "acc"/"ACC")
- **Использует кэш**: Внутри вызывает `GetAllPidAcc()`

---

## GetAcc

### Назначение
Получает имя аккаунта, связанное с конкретным идентификатором процесса.

### Пример
```csharp
int pid = 12345;
string acc = ProcAcc.GetAcc(pid);

if (acc != null)
{
    Console.WriteLine($"PID {pid} принадлежит аккаунту: {acc}");
}
else
{
    Console.WriteLine($"PID {pid} не найден или не связан с аккаунтом");
}
```

### Разбор
```csharp
public static string GetAcc(int pid)
```
- **Параметр `pid`**: Идентификатор процесса для поиска
- **Возвращает**: Имя аккаунта (string) если найден, `null` если PID не существует или нет связи
- **Использует кэш**: Внутри вызывает `GetAllPidAcc()`

---

## IsRunning

### Назначение
Проверяет, есть ли у аккаунта запущенные процессы.

### Пример
```csharp
if (ProcAcc.IsRunning("acc123"))
{
    Console.WriteLine("Аккаунт acc123 сейчас запущен");
}
else
{
    Console.WriteLine("Аккаунт acc123 не запущен");
}
```

### Разбор
```csharp
public static bool IsRunning(string acc)
```
- **Параметр `acc`**: Имя аккаунта для проверки
- **Возвращает**: `true` если у аккаунта есть хотя бы один запущенный процесс, `false` в противном случае
- **Реализация**: Проверяет условие `GetPids(acc).Count > 0`

---

## ClearCache

### Назначение
Очищает внутренний кэш связей PID-ACC. Должен вызываться после завершения процессов для обеспечения свежих данных при следующем запросе.

### Пример
```csharp
// Завершить процесс
ProcAcc.KillPid(12345);

// Очистить кэш для обеспечения свежих данных при следующем запросе
ProcAcc.ClearCache();

// Теперь это просканирует свежие данные
var pids = ProcAcc.GetAllPidAcc();
```

### Разбор
```csharp
public static void ClearCache()
```
- **Без параметров**
- **Не возвращает значение**
- **Потокобезопасность**: Использует внутреннюю блокировку
- **Когда использовать**: После завершения процессов или когда нужны абсолютно свежие данные

---

## GetNewlyLaunchedPid

### Назначение
Быстрый поиск только что запущенного процесса браузера. Ищет только среди процессов, которых не было до запуска.

### Пример
```csharp
// Перед запуском браузера сделать снимок
HashSet<int> pidsBefore = ProcAcc.GetPidSnapshot();

// Запустить браузер для аккаунта acc123
// ... код запуска браузера ...

// Найти новый PID (ждет до 1 секунды с 10 попытками)
int newPid = ProcAcc.GetNewlyLaunchedPid("acc123", pidsBefore, maxAttempts: 10, delayMs: 100);

if (newPid > 0)
{
    Console.WriteLine($"Браузер успешно запущен с PID: {newPid}");
}
else
{
    Console.WriteLine("Не удалось обнаружить новый процесс браузера");
}
```

### Разбор
```csharp
public static int GetNewlyLaunchedPid(string acc, HashSet<int> pidsBeforeLaunch, int maxAttempts = 10, int delayMs = 100)
```
- **Параметр `acc`**: Имя аккаунта для поиска
- **Параметр `pidsBeforeLaunch`**: Набор PID, существовавших до запуска браузера (используйте `GetPidSnapshot()`)
- **Параметр `maxAttempts`**: Максимальное количество попыток поиска (по умолчанию: 10)
- **Параметр `delayMs`**: Задержка между попытками в миллисекундах (по умолчанию: 100)
- **Возвращает**: Идентификатор нового процесса если найден, `0` если не найден
- **Побочный эффект**: Очищает кэш при обнаружении процесса
- **Производительность**: Сканирует только новые процессы, а не все

---

## GetPidSnapshot

### Назначение
Создает снимок всех текущих идентификаторов процессов zbe1. Используется для обнаружения вновь запущенных процессов.

### Пример
```csharp
// Сделать снимок перед запуском
HashSet<int> before = ProcAcc.GetPidSnapshot();

// Запустить браузер
// ...

// Сделать снимок после запуска
HashSet<int> after = ProcAcc.GetPidSnapshot();

// Найти новые PID
var newPids = after.Except(before);
foreach (int pid in newPids)
{
    Console.WriteLine($"Обнаружен новый процесс: {pid}");
}
```

### Разбор
```csharp
public static HashSet<int> GetPidSnapshot()
```
- **Без параметров**
- **Возвращает**: HashSet всех текущих идентификаторов процессов zbe1
- **Быстрая операция**: Получает только идентификаторы процессов, не читает командные строки
- **Сценарий использования**: Обнаружение вновь запущенных процессов

---

## FindFirstNewPid

### Назначение
Альтернативный метод для поиска вновь запущенного браузера. Ищет первый процесс с нужным аккаунтом, который стартовал после указанного времени. Прерывается сразу после нахождения.

### Пример
```csharp
// Записать время запуска
DateTime launchTime = DateTime.Now;

// Запустить браузер
// ... код запуска браузера ...

// Найти новый PID (ждет до 2 секунд)
int newPid = ProcAcc.FindFirstNewPid("acc123", launchTime, maxWaitMs: 2000);

if (newPid > 0)
{
    Console.WriteLine($"Найден новый процесс браузера: {newPid}");
}
```

### Разбор
```csharp
public static int FindFirstNewPid(string acc, DateTime launchedAfter, int maxWaitMs = 2000)
```
- **Параметр `acc`**: Имя аккаунта для поиска
- **Параметр `launchedAfter`**: Учитывать только процессы, запущенные после этого времени
- **Параметр `maxWaitMs`**: Максимальное время ожидания в миллисекундах (по умолчанию: 2000)
- **Возвращает**: Идентификатор процесса если найден, `0` если не найден в течение таймаута
- **Побочный эффект**: Очищает кэш при обнаружении процесса
- **Производительность**: Останавливается сразу после нахождения первого совпадения

---

## GetNewest

### Назначение
Получает самый новый (недавно запущенный) идентификатор процесса для аккаунта.

### Пример
```csharp
int newestPid = ProcAcc.GetNewest("acc123");

if (newestPid > 0)
{
    Console.WriteLine($"Самый новый процесс для acc123: {newestPid}");
}
else
{
    Console.WriteLine("Процессы для acc123 не найдены");
}
```

### Разбор
```csharp
public static int GetNewest(string acc)
```
- **Параметр `acc`**: Имя аккаунта
- **Возвращает**: PID самого нового процесса, `0` если процессы не найдены
- **Критерий выбора**: Процесс с наивысшим `StartTime`

---

## GetOldest

### Назначение
Получает самый старый (наиболее долго работающий) идентификатор процесса для аккаунта.

### Пример
```csharp
int oldestPid = ProcAcc.GetOldest("acc123");

if (oldestPid > 0)
{
    Console.WriteLine($"Самый старый процесс для acc123: {oldestPid}");
}
```

### Разбор
```csharp
public static int GetOldest(string acc)
```
- **Параметр `acc`**: Имя аккаунта
- **Возвращает**: PID самого старого процесса, `0` если процессы не найдены
- **Критерий выбора**: Процесс с наименьшим `StartTime`

---

## GetHeaviest

### Назначение
Получает идентификатор процесса, использующего больше всего памяти для аккаунта.

### Пример
```csharp
int heaviestPid = ProcAcc.GetHeaviest("acc123");

if (heaviestPid > 0)
{
    Console.WriteLine($"Процесс использующий больше всего памяти: {heaviestPid}");
}
```

### Разбор
```csharp
public static int GetHeaviest(string acc)
```
- **Параметр `acc`**: Имя аккаунта
- **Возвращает**: PID процесса с наибольшим использованием памяти, `0` если процессы не найдены
- **Критерий выбора**: Процесс с наивысшим `WorkingSet64` (использование памяти)

---

## GetLightest

### Назначение
Получает идентификатор процесса, использующего меньше всего памяти для аккаунта.

### Пример
```csharp
int lightestPid = ProcAcc.GetLightest("acc123");

if (lightestPid > 0)
{
    Console.WriteLine($"Процесс использующий меньше всего памяти: {lightestPid}");
}
```

### Разбор
```csharp
public static int GetLightest(string acc)
```
- **Параметр `acc`**: Имя аккаунта
- **Возвращает**: PID процесса с наименьшим использованием памяти, `0` если процессы не найдены
- **Критерий выбора**: Процесс с наименьшим `WorkingSet64` (использование памяти)

---

## Kill

### Назначение
Завершает все процессы, связанные с аккаунтом.

### Пример
```csharp
int killedCount = ProcAcc.Kill("acc123");

Console.WriteLine($"Завершено {killedCount} процесс(ов) для acc123");

// Кэш автоматически очищается после успешного завершения
```

### Разбор
```csharp
public static int Kill(string acc)
```
- **Параметр `acc`**: Имя аккаунта
- **Возвращает**: Количество успешно завершенных процессов
- **Побочный эффект**: Автоматически очищает кэш если были завершены процессы
- **Обработка ошибок**: Молча перехватывает исключения для отдельных завершений процессов

---

## KillOld

### Назначение
Завершает все процессы для аккаунта КРОМЕ самого нового. Полезно для очистки дублирующихся/старых экземпляров браузера.

### Пример
```csharp
// У аккаунта запущено 3 процесса
int killedCount = ProcAcc.KillOld("acc123");

Console.WriteLine($"Завершено {killedCount} старых процесс(ов), оставлен самый новый");
```

### Разбор
```csharp
public static int KillOld(string acc)
```
- **Параметр `acc`**: Имя аккаунта
- **Возвращает**: Количество завершенных старых процессов
- **Оставляет живым**: Самый новый процесс (наивысший `StartTime`)
- **Побочный эффект**: Автоматически очищает кэш если были завершены процессы
- **Сценарий использования**: Предотвращение множественных экземпляров браузера для одного аккаунта

---

## KillPid

### Назначение
Завершает конкретный процесс по его идентификатору.

### Пример
```csharp
int pidToKill = 12345;
bool success = ProcAcc.KillPid(pidToKill);

if (success)
{
    Console.WriteLine($"Процесс {pidToKill} успешно завершен");
}
else
{
    Console.WriteLine($"Не удалось завершить процесс {pidToKill}");
}
```

### Разбор
```csharp
public static bool KillPid(int pid)
```
- **Параметр `pid`**: Идентификатор процесса для завершения
- **Возвращает**: `true` если процесс был завершен, `false` если не удалось или процесс не существует
- **Побочный эффект**: Автоматически очищает кэш при успехе
- **Обработка ошибок**: Возвращает `false` при любом исключении

---

## GetDetails

### Назначение
Получает детальную информацию о всех процессах, связанных с аккаунтом (использование памяти, время работы, количество потоков).

### Пример
```csharp
List<string> details = ProcAcc.GetDetails("acc123");

Console.WriteLine($"Детали для acc123:");
foreach (string info in details)
{
    Console.WriteLine(info);
    // Пример вывода: "PID:12345, Mem:150MB, Up:25min, Threads:42"
}
```

### Разбор
```csharp
public static List<string> GetDetails(string acc)
```
- **Параметр `acc`**: Имя аккаунта
- **Возвращает**: Список форматированных строк с деталями процессов
- **Формат**: `"PID:{pid}, Mem:{память}MB, Up:{время_работы}min, Threads:{количество}"`
- **Включенная информация**: Идентификатор процесса, память в МБ, время работы в минутах, количество потоков
- **Обработка ошибок**: Молча пропускает процессы, вызывающие исключения

---

## PidReport

### Назначение
Генерирует комплексный отчет обо всех запущенных процессах, включая как привязанные (связанные с аккаунтами), так и непривязанные процессы.

### Пример
```csharp
Dictionary<int, List<object>> report = ProcAcc.PidReport();

foreach (var entry in report)
{
    int pid = entry.Key;
    int mem = Convert.ToInt32(entry.Value[0]);      // Память в МБ
    int age = Convert.ToInt32(entry.Value[1]);      // Возраст в минутах
    string proj = entry.Value[2].ToString();         // Имя проекта
    string acc = entry.Value[3].ToString();          // Имя аккаунта

    Console.WriteLine($"PID: {pid}, ACC: {acc}, Mem: {mem}MB, Age: {age}min");
}
```

### Разбор
```csharp
public static Dictionary<int, List<object>> PidReport()
```
- **Без параметров**
- **Возвращает**: Словарь где ключ - PID, значение - список содержащий: `[память(МБ), возраст(минуты), проект, аккаунт]`
- **Структура данных**: `List<object>` с 4 элементами: `[int mem, int age, string proj, string acc]`
- **Интеграция**: Обновляет данные класса `Running`
- **Побочный эффект**: Вызывает `Running.PruneAndUpdate()` для очистки мертвых процессов

---

## zbe1

### Назначение
Получает список всех текущих идентификаторов процессов zbe1. Это низкоуровневый метод, используемый внутренне.

### Пример
```csharp
List<int> allZbe1Pids = ProcAcc.zbe1();

Console.WriteLine($"Всего процессов zbe1: {allZbe1Pids.Count}");
foreach (int pid in allZbe1Pids)
{
    Console.WriteLine($"  - {pid}");
}
```

### Разбор
```csharp
public static List<int> zbe1()
```
- **Без параметров**
- **Возвращает**: Список всех идентификаторов процессов zbe1
- **Имя процесса**: Ищет процессы с именем "zbe1"
- **Управление ресурсами**: Корректно освобождает объекты Process в блоке finally
- **Производительность**: Быстрая операция, получает только PID без дополнительных данных
