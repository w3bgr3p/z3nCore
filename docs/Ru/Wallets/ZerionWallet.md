# Класс ZerionWallet

Класс `ZerionWallet` обеспечивает автоматизацию работы с расширением браузера Zerion Wallet, поддерживающим Ethereum и EVM-совместимые сети.

---

## Конструктор

### ZerionWallet

**Назначение**: Инициализирует новый экземпляр класса ZerionWallet с конфигурацией кошелька и настройкой расширения.

**Пример**:
```csharp
var zerion = new ZerionWallet(project, instance, log: true, key: "key");
```

**Разбор**:
```csharp
public ZerionWallet(
    IZennoPosterProjectModel project,                    // Модель проекта ZennoPoster
    Instance instance,                                    // Экземпляр браузера
    bool log = false,                                     // Включить подробное логирование (по умолчанию: false)
    string key = null,                                    // Приватный ключ или "seed" (по умолчанию: null, загружает "evm" ключ из БД)
    string fileName = "Zerion1.21.3.crx"                 // Имя CRX файла расширения (по умолчанию: "Zerion1.21.3.crx")
)
// - Загружает ключ из базы данных, если параметр key равен "key" или "seed"
// - Вычисляет и сохраняет ожидаемый Ethereum адрес из ключа
// - Извлекает пароль устройства из безопасного хранилища
```

---

## Публичные методы

### Launch

**Назначение**: Устанавливает расширение Zerion Wallet, импортирует или разблокирует кошелек и возвращает активный Ethereum адрес.

**Пример**:
```csharp
var zerion = new ZerionWallet(project, instance);
string address = zerion.Launch(source: "key", refCode: "MYREF123");
project.SendInfoToLog($"Адрес кошелька: {address}");
```

**Разбор**:
```csharp
public string Launch(
    string fileName = null,   // Имя CRX файла (по умолчанию: использует значение из конструктора)
    bool log = false,         // Включить логирование (по умолчанию: false)
    string source = null,     // Источник ключа: "key" или "seed" (по умолчанию: "key")
    string refCode = null     // Опциональный реферальный код для новых кошельков
)
// Возвращает: Активный Ethereum адрес (string)
// - Отключает полную эмуляцию мыши
// - Переключается на и устанавливает расширение Zerion
// - Проверяет состояние кошелька (onboarding, unlock или ready)
// - Если onboarding: импортирует кошелек с опциональным реферальным кодом
// - Если заблокирован: разблокирует кошелек
// - Если нет вкладки: переходит на popup Zerion
// - Отключает режим testnet
// - Извлекает активный адрес
// - Сохраняет адрес в переменной проекта
// - Закрывает лишние вкладки
// - Восстанавливает эмуляцию мыши
```

---

### Sign

**Назначение**: Подписывает транзакцию или сообщение путем нажатия кнопки "Confirm" или "Sign" в Zerion.

**Пример**:
```csharp
var zerion = new ZerionWallet(project, instance);
bool success = zerion.Sign(deadline: 20);
```

**Разбор**:
```csharp
public bool Sign(
    bool log = false,     // Включить логирование (по умолчанию: false)
    int deadline = 10     // Максимальное время ожидания запроса на подписание (по умолчанию: 10 секунд)
)
// Возвращает: true, если подписание было успешным (bool)
// - Сканирует вкладки расширения Zerion
// - Парсит URL для извлечения информации о транзакции
// - Сначала пытается нажать кнопку "Confirm"
// - Если "Confirm" не найдена, пробует кнопку "Sign"
// - Прерывается после указанного deadline
// - Возвращает true, когда кнопка успешно нажата
// - Выбрасывает исключение, если deadline превышен
```

---

### Connect

**Назначение**: Обрабатывает запросы подключения от dApps к Zerion Wallet, подтверждая все шаги подключения.

**Пример**:
```csharp
var zerion = new ZerionWallet(project, instance);
zerion.Connect();
```

**Разбор**:
```csharp
public void Connect(
    bool log = false  // Включить логирование (по умолчанию: false)
)
// Возвращает: void
// - Постоянно проверяет наличие кнопок действий в popup Zerion
// - Обрабатывает множественные шаги подключения: "Add", "Close", "Connect", "Sign", "Sign In"
// - Нажимает основную кнопку для каждого шага
// - Логирует текущее действие и информацию о сайте
// - Использует паттерн goto для логики конечного автомата
// - Возвращается, когда вкладка кошелька не найдена (подключение завершено)
```

---

### SwitchSource

**Назначение**: Переключается между разными импортированными кошельками (на основе ключа или сид-фразы) в Zerion.

**Пример**:
```csharp
var zerion = new ZerionWallet(project, instance);
zerion.SwitchSource("seed");  // Переключение на кошелек на основе сид-фразы
```

**Разбор**:
```csharp
public void SwitchSource(
    string addressToUse = "key"  // Адрес для переключения: "key" или "seed" (по умолчанию: "key")
)
// Возвращает: void
// - Преобразует "key" или "seed" в фактический Ethereum адрес
// - Переходит на страницу выбора кошелька
// - Ожидает загрузки списка кошельков
// - Итерируется по доступным кошелькам
// - Парсит информацию о кошельке (замаскированный адрес, баланс, ENS имя)
// - Сравнивает замаскированные адреса с целевым адресом
// - Если найден: нажимает для активации кошелька
// - Если не найден: добавляет кошелек и повторяет попытку
// - Закрывает лишние вкладки после переключения
```

---

### WaitTx

**Назначение**: Ожидает подтверждения или неудачи транзакции путем мониторинга истории транзакций.

**Пример**:
```csharp
var zerion = new ZerionWallet(project, instance);
bool success = zerion.WaitTx(deadline: 120);
if (success)
    project.SendInfoToLog("Транзакция подтверждена!");
```

**Разбор**:
```csharp
public bool WaitTx(
    int deadline = 60,  // Максимальное время ожидания в секундах (по умолчанию: 60)
    bool log = false    // Включить логирование (по умолчанию: false)
)
// Возвращает: true, если транзакция успешна, false, если не удалась (bool)
// - Открывает новую вкладку и переходит в историю транзакций Zerion
// - Извлекает статус последней транзакции
// - Если "Pending": ожидает и проверяет снова
// - Если "Failed": возвращает false
// - Если "Execute": возвращает true
// - Выбрасывает исключение, если deadline превышен
// - Закрывает лишние вкладки перед возвратом
```

---

### Claimable

**Назначение**: Извлекает список доступных для получения квестов Zerion DNA для указанного адреса кошелька.

**Пример**:
```csharp
var zerion = new ZerionWallet(project, instance);
List<string> questIds = zerion.Claimable("0x1234...5678");
foreach (string questId in questIds)
{
    project.SendInfoToLog($"Доступный квест: {questId}");
}
```

**Разбор**:
```csharp
public List<string> Claimable(
    string address  // Ethereum адрес для проверки доступных квестов
)
// Возвращает: Список ID доступных квестов (List<string>)
// - Выполняет HTTP GET запрос к API Zerion DNA
// - Парсит JSON ответ, содержащий информацию о квестах
// - Итерируется по всем квестам
// - Фильтрует квесты, где количество доступных > 0
// - Логирует каждый доступный квест с ID и типом
// - Возвращает список ID доступных квестов
// - Корректно обрабатывает ошибки парсинга
```

---

### ActiveAddress

**Назначение**: Извлекает текущий активный Ethereum адрес кошелька из Zerion.

**Пример**:
```csharp
var zerion = new ZerionWallet(project, instance);
string address = zerion.ActiveAddress();
project.SendInfoToLog($"Активный адрес: {address}");
```

**Разбор**:
```csharp
public string ActiveAddress()
// Возвращает: Активный Ethereum адрес (string)
// - Находит элемент ссылки получения, содержащий адрес
// - Извлекает атрибут href
// - Удаляет префикс URL для получения чистого адреса
// - Логирует извлеченный адрес
// - Возвращает адрес
```

---

## Публичные статические методы

### TxFromUrl

**Назначение**: Извлекает данные транзакции из URL Zerion, содержащего параметры транзакции.

**Пример**:
```csharp
string url = "chrome-extension://...#/send?transaction={...}";
string txJson = ZerionWallet.TxFromUrl(url);
project.SendInfoToLog($"Транзакция: {txJson}");
```

**Разбор**:
```csharp
public static string TxFromUrl(
    string url  // URL Zerion, содержащий данные транзакции
)
// Возвращает: JSON строка, содержащая данные транзакции (string)
// - Парсит URL и извлекает строку запроса или фрагмент
// - Ищет параметр "transaction="
// - URL-декодирует данные транзакции
// - Десериализует JSON для проверки наличия полей "to" и "from"
// - Возвращает JSON строку транзакции
// - Выбрасывает ArgumentException, если URL неверный или данные транзакции отсутствуют
// - Выбрасывает Exception с подробным сообщением об ошибке, если парсинг не удается
```

---

### Replace

**Назначение**: Метод-заглушка для функциональности замены транзакции (еще не реализован).

**Пример**:
```csharp
string newTx = ZerionWallet.Replace(originalTx);
```

**Разбор**:
```csharp
public static string Replace(
    string tx  // Данные транзакции для замены
)
// Возвращает: Пустая строка (string)
// - В настоящее время возвращает пустую строку
// - Предназначен для будущей функциональности замены транзакций
```
