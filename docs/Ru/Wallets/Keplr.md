# Класс Keplr

Класс `Keplr` обеспечивает автоматизацию работы с расширением браузера Keplr Wallet, которое поддерживает блокчейны на основе Cosmos.

---

## Конструктор

### Keplr

**Назначение**: Инициализирует новый экземпляр класса Keplr для взаимодействия с расширением Keplr Wallet.

**Пример**:
```csharp
var keplr = new Keplr(project, instance, log: true);
```

**Разбор**:
```csharp
public Keplr(
    IZennoPosterProjectModel project,  // Модель проекта ZennoPoster
    Instance instance,                  // Экземпляр браузера
    bool log = false,                   // Включить подробное логирование (по умолчанию: false)
    string key = null,                  // Приватный ключ (опционально, загружается из БД если null)
    string seed = null                  // Сид-фраза (опционально, загружается из БД если null)
)
```

---

## Публичные методы

### Launch

**Назначение**: Устанавливает расширение Keplr Wallet, импортирует кошелек или разблокирует его и устанавливает активный источник кошелька.

**Пример**:
```csharp
var keplr = new Keplr(project, instance);
keplr.Launch(source: "seed");  // Запуск с кошельком на основе сид-фразы
```

**Разбор**:
```csharp
public void Launch(
    string source = "seed",       // Источник кошелька: "seed" или "keyEvm" (по умолчанию: "seed")
    string fileName = null,       // Имя CRX файла (по умолчанию: использует константу класса)
    bool log = false              // Включить логирование (по умолчанию: false)
)
// Возвращает: void
// - Определяет тип браузера (Chromium или ChromiumFromZB)
// - Устанавливает расширение Keplr из CRX или Chrome Web Store
// - Отключает полную эмуляцию мыши для более быстрого взаимодействия
// - Переходит на popup Keplr
// - Проверяет состояние кошелька (onboarding, unlock или ready)
// - Если onboarding: импортирует кошелек используя указанный источник
// - Если заблокирован: разблокирует кошелек
// - Устанавливает активный источник кошелька
// - Закрывает лишние вкладки
// - Возвращается на popup
```

---

### SetSource

**Назначение**: Устанавливает, какой импортированный кошелек (seed или приватный ключ) должен быть активным в Keplr.

**Пример**:
```csharp
var keplr = new Keplr(project, instance);
keplr.Launch();
keplr.SetSource("keyEvm");  // Переключение на кошелек с приватным ключом
```

**Разбор**:
```csharp
public void SetSource(
    string source,    // Источник кошелька для активации: "seed" или "keyEvm"
    bool log = false  // Включить логирование (по умолчанию: false)
)
// Возвращает: void
// - Переходит на страницу выбора кошелька
// - Удаляет кошельки, которые не являются seed или keyEvm
// - Проверяет, импортированы ли оба требуемых кошелька
// - Если оба существуют: нажимает на запрошенный источник для активации
// - Если отсутствует: добавляет отсутствующий кошелек и повторяет попытку
// - Обеспечивает постоянную доступность кошельков "seed" и "keyEvm"
```

---

### Unlock

**Назначение**: Разблокирует Keplr Wallet используя сохраненный пароль.

**Пример**:
```csharp
var keplr = new Keplr(project, instance);
keplr.Unlock();
```

**Разбор**:
```csharp
public void Unlock(
    bool log = false  // Включить логирование (по умолчанию: false)
)
// Возвращает: void
// - Переходит на popup Keplr
// - Проверяет, разблокирован ли уже (ищет кнопку "Copy Address")
// - Если разблокирован: немедленно возвращается
// - Если заблокирован: вводит пароль и нажимает кнопку разблокировки
// - Проверяет правильность пароля (проверяет сообщение "Invalid password")
// - Если неверный пароль: удаляет расширение и выбрасывает исключение
// - Использует логику повтора с паттерном goto для надежности
// - Отображает общий доступный баланс при разблокировке
```

---

### Sign

**Назначение**: Подтверждает транзакцию или запрос на подписание сообщения в Keplr Wallet.

**Пример**:
```csharp
var keplr = new Keplr(project, instance);
keplr.Sign();
```

**Разбор**:
```csharp
public void Sign(
    bool log = false  // Включить логирование (по умолчанию: false)
)
// Возвращает: void
// - Ожидает до 20 секунд появления вкладки Keplr
// - Выбрасывает исключение, если вкладка Keplr не обнаружена в пределах таймаута
// - Отключает полную эмуляцию мыши для более быстрого нажатия
// - Нажимает кнопку "Approve"
// - Ожидает закрытия вкладки Keplr (указывающего на подтверждение транзакции)
// - Повторяет подтверждение, если вкладка не закрывается немедленно
// - Выбрасывает исключение, если вкладка остается открытой после таймаута
// - Снова включает полную эмуляцию мыши перед возвратом
```
