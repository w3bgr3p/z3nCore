# Класс KeplrWallet

Класс `KeplrWallet` обеспечивает автоматизацию работы с расширением браузера Keplr Wallet с пользовательской обработкой кликов для специфичных конфигураций браузера.

---

## Конструктор

### KeplrWallet

**Назначение**: Инициализирует новый экземпляр класса KeplrWallet для взаимодействия с расширением Keplr Wallet.

**Пример**:
```csharp
var keplrWallet = new KeplrWallet(project, instance, log: true);
```

**Разбор**:
```csharp
public KeplrWallet(
    IZennoPosterProjectModel project,  // Модель проекта ZennoPoster
    Instance instance,                  // Экземпляр браузера
    bool log = false,                   // Включить подробное логирование (по умолчанию: false)
    string key = null,                  // Приватный ключ (опционально, загружается из БД если null)
    string seed = null                  // Сид-фраза (опционально, загружается из БД если null)
)
```

---

## Публичные методы

### Launch

**Назначение**: Устанавливает расширение Keplr Wallet, импортирует кошелек или разблокирует его и устанавливает активный источник кошелька.

**Пример**:
```csharp
var keplrWallet = new KeplrWallet(project, instance);
keplrWallet.Launch(source: "seed");  // Запуск с кошельком на основе сид-фразы
```

**Разбор**:
```csharp
public void Launch(
    string source = "seed",       // Источник кошелька: "seed" или "keyEvm" (по умолчанию: "seed")
    string fileName = null,       // Имя CRX файла (по умолчанию: "Keplr0.12.223.crx")
    bool log = false              // Включить логирование (по умолчанию: false)
)
// Возвращает: void
// - Отключает полную эмуляцию мыши
// - Переключается на расширение Keplr
// - Если новая установка: импортирует кошелек используя указанный источник
// - Если уже установлен: разблокирует кошелек
// - Устанавливает активный источник кошелька
// - Закрывает лишние вкладки
// - Восстанавливает предыдущую настройку эмуляции мыши
```

---

### SetSource

**Назначение**: Устанавливает, какой импортированный кошелек (seed или приватный ключ) должен быть активным в Keplr.

**Пример**:
```csharp
var keplrWallet = new KeplrWallet(project, instance);
keplrWallet.Launch();
keplrWallet.SetSource("keyEvm");  // Переключение на кошелек с приватным ключом
```

**Разбор**:
```csharp
public void SetSource(
    string source,    // Источник кошелька для активации: "seed" или "keyEvm"
    bool log = false  // Включить логирование (по умолчанию: false)
)
// Возвращает: void
// - Переходит на страницу выбора кошелька
// - Удаляет кошельки, которые не являются seed или keyEvm
// - Проверяет, импортированы ли оба требуемых кошелька
// - Если оба существуют: использует KeplrClick для выбора запрошенного источника
// - Если отсутствует: добавляет отсутствующий кошелек и повторяет попытку
// - Использует пользовательский метод KeplrClick для специфичной обработки кликов браузера
```

---

### Unlock

**Назначение**: Разблокирует Keplr Wallet используя сохраненный пароль.

**Пример**:
```csharp
var keplrWallet = new KeplrWallet(project, instance);
keplrWallet.Unlock();
```

**Разбор**:
```csharp
public void Unlock(
    bool log = false  // Включить логирование (по умолчанию: false)
)
// Возвращает: void
// - Переходит на popup Keplr
// - Проверяет, разблокирован ли уже (ищет кнопку "Copy Address")
// - Если разблокирован: немедленно возвращается
// - Если заблокирован: вводит пароль и использует KeplrClick для разблокировки
// - Проверяет правильность пароля (проверяет сообщение "Invalid password")
// - Если неверный пароль: закрывает вкладки, удаляет расширение и выбрасывает исключение
// - Использует логику повтора с паттерном goto для надежности
// - Использует пользовательский метод KeplrClick для нажатия кнопки разблокировки
```

---

### Sign

**Назначение**: Подтверждает транзакцию или запрос на подписание сообщения в Keplr Wallet.

**Пример**:
```csharp
var keplrWallet = new KeplrWallet(project, instance);
keplrWallet.Sign();
```

**Разбор**:
```csharp
public void Sign(
    bool log = false  // Включить логирование (по умолчанию: false)
)
// Возвращает: void
// - Ожидает до 20 секунд появления вкладки Keplr
// - Выбрасывает исключение, если вкладка Keplr не обнаружена в пределах таймаута
// - Отключает полную эмуляцию мыши для более быстрого взаимодействия
// - Нажимает кнопку "Approve" используя HeClick
// - Ожидает закрытия вкладки Keplr (указывающего на подтверждение транзакции)
// - Повторяет подтверждение, если вкладка не закрывается немедленно
// - Выбрасывает исключение, если вкладка остается открытой после таймаута
// - Снова включает полную эмуляцию мыши перед возвратом
```

---

### KeplrApprove

**Назначение**: Устаревший метод для подтверждения транзакций. Внутренне вызывает метод Sign.

**Пример**:
```csharp
var keplrWallet = new KeplrWallet(project, instance);
string result = keplrWallet.KeplrApprove();
```

**Разбор**:
```csharp
public string KeplrApprove(
    bool log = false  // Включить логирование (по умолчанию: false)
)
// Возвращает: "done" (string)
// - Помечает этот метод как устаревший (заменен на Sign)
// - Внутренне вызывает Sign(log)
// - Возвращает строку "done" после успешного подтверждения
// - Предоставлен для обратной совместимости
```
