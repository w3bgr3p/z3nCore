

##  CommonTx

### Назначение

Класс **CommonTx** реализует универсальный интерфейс для создания и отправки типовых транзакций в EVM-сетях через RPC:

- выдача разрешений (approve) для токенов ERC20,
- обёртывание (wrap) нативного токена (например, ETH → WETH),
- отправка нативного токена (ETH, BNB и др.) на указанный адрес.

Поддерживает работу с произвольным RPC, автоматическую подстановку ключа и адреса, логирование и сохранение хэша транзакции в переменную проекта.

### Примеры использования

```csharp
// Создать экземпляр с логированием и своим ключом
var tx = new CommonTx(project, key: "0x...", log: true);

// Отправить approve на максимальную сумму для контракта токена
string txHash = tx.Approve("0xTokenContract", "0xSpender", "max");

// Отправить approve с отменой разрешения
string txHash = tx.Approve("0xTokenContract", "0xSpender", "cancel");

// Обернуть 0.5 ETH в WETH
string txHash = tx.Wrap("0xWETHContract", 0.5m);

// Отправить 0.1 ETH на адрес
string txHash = tx.Send("0xRecipient", 0.1m);
```


## Описание методов

### Конструктор

```csharp
public CommonTx(IZennoPosterProjectModel project, string key = null, bool log = false)
```

- **key**: приватный ключ (hex, опционально; если не задан — берётся из базы).
- **log**: включает логирование.
- В конструкторе определяется публичный адрес, создаётся вспомогательный объект для чтения RPC.


### Approve

```csharp
public string Approve(string contract, string spender, string amount, string rpc = "")
```

- **contract**: адрес токена ERC20.
- **spender**: адрес контракта-оператора (кому разрешается тратить токены).
- **amount**: сумма разрешения:
    - `"max"` — максимальное разрешение (2^256-1, полный approve),
    - `"cancel"` — отмена разрешения (approve на 0),
    - любое другое число — конкретная сумма (uint256).
- **rpc**: RPC-эндпоинт (если не задан — берётся из настроек).
- Формирует транзакцию `approve(spender, amount)` по ABI, кодирует данные, отправляет через SendLegacy.
- Сохраняет хэш транзакции в переменную проекта `blockchainHash`.
- Логирует все этапы и ошибки.
- Возвращает хэш транзакции.


### Wrap

```csharp
public string Wrap(string contract, decimal value, string rpc = "")
```

- **contract**: адрес контракта обёртывания (например, WETH).
- **value**: сумма для обёртывания (в ETH, BNB и т.д.).
- **rpc**: RPC-эндпоинт (если не задан — берётся из настроек).
- Формирует транзакцию `deposit()` (ABI для wrap), отправляет через SendLegacy с value.
- Сохраняет хэш транзакции в переменную проекта `blockchainHash`.
- Логирует все этапы и ошибки.
- Возвращает хэш транзакции.


### Send

```csharp
public string Send(string to, decimal amount, string rpc = "")
```

- **to**: адрес получателя.
- **amount**: сумма для отправки (в ETH, BNB и т.д.).
- **rpc**: RPC-эндпоинт (если не задан — берётся из настроек).
- Отправляет обычную транзакцию перевода value на указанный адрес через SendLegacy.
- Сохраняет хэш транзакции в переменную проекта `blockchainHash`.
- Логирует все этапы и ошибки.
- Возвращает хэш транзакции.


## Вспомогательные детали

- Для всех методов:
    - Культура потока устанавливается в `InvariantCulture` для корректной работы с числами.
    - Ключ и адрес автоматически подставляются из базы или параметра конструктора.
    - Все ошибки логируются и пробрасываются.
    - Хэш транзакции всегда сохраняется в переменную проекта `blockchainHash` (если возможно).
- Для `Approve` поддерживается автоматическая подстановка максимального значения и отмена разрешения.


## Особенности

- Универсальный интерфейс для типовых EVM-транзакций: approve, wrap, send.
- Поддержка любого RPC, автоматическая подстановка ключа и адреса.
- Логирование и сохранение хэша транзакции.
- Корректная обработка ошибок и исключений.
- Поддержка спецрежимов (`max`, `cancel`) для approve.

